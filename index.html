<html>
  <head>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="main"></div>
    <script>
      /**
       * Socket.io
       */
      var socket = io("ws://localhost:3000", { transports: ["websocket"] });
      socket.on("connect", function () {
        console.log(socket.id);
      });

      socket.on("command", (info) => {
        console.log("getEvent");
        console.log(info);
        switch (info.command) {
          case "update_room":
            UpdateRoomList(info.room_list);
            break;
          case "room_info":
            MakeRoom();
            UpdateRoomInfo(info.room_info);
            UpdateGameInfo(info.game_info);
            break;
          case "turn":
            console.log("턴바뀜");
            break;
          case "put_stone":
            break;
          default:
            console.log("command not found", info.command);
        }
      });

      socket.on("disconnect", function () {
        console.log(socket.id);
      });

      function UpdateRoomList(room_list) {
        let main = newMain();

        // add create room button
        let create_room_button = document.createElement("button");
        create_room_button.innerText = "Create Room";
        create_room_button.addEventListener("click", () => {
          socket.emit("create_room");
        });
        main.appendChild(create_room_button);

        // TODO: add quick join button

        // add room list
        room_list.forEach(({ room_id, room_status }) => {
          let room_div = document.createElement("div");
          room_div.innerHTML = room_id + " " + room_status;
          room_div.addEventListener("click", () => {
            socket.emit("join_room", { room_id });
          });
          room_div.classList.add("room");
          main.appendChild(room_div);
        });
      }

      function MakeRoom() {
        let main = newMain();
        let info_div = document.createElement("div");
        info_div.id = "info";
        main.appendChild(info_div);
        let game_table = document.createElement("table");
        game_table.id = "game_table";
        main.appendChild(game_table);
      }

      function UpdateRoomInfo({ room_status, player, spectator }) {
        /**
         * room_status: "waiting"
           player: [[player,isready]...]
           spectator: [name...]
         */
        let info_div = document.querySelector("#info");
        info_div.innerHTML = room_status;
        player.forEach((p, idx) => {
          let player_div = document.createElement("div");
          if (p[0] === socket.id) {
            p[0] = "나";
            let ready_div = document.createElement("button");
            ready_div.id = "ready";
            ready_div.innerText = "대결하기";
            ready_div.addEventListener("click", () => {
              socket.emit("ready");
              document.querySelector("#ready").remove();
            });
            info_div.appendChild(ready_div);
          } // check me
          player_div.innerText =
            idx +
            1 +
            "번 유저: " +
            p[0] +
            ", 준비상태 : " +
            (p[1] === "1" ? "준비됨" : "대기중");
          player_div.classList.add("player");
          info_div.appendChild(player_div);
        });
        spectator.forEach((s, idx) => {
          let spectator_div = document.createElement("div");
          if (s === socket.id) s = "나";
          spectator_div.innerText = idx + 1 + "번 관전자: " + s;
          spectator_div.classList.add("spectator");
          info_div.appendChild(spectator_div);
        });
      }

      function UpdateGameInfo(game_info) {
        /**
         *  info: arr[8][8]  // -1 : empty, 0 : black, 1 : white
         */
        let game_table = document.querySelector("#game_table");
        game_info.forEach((i, idx) => {
          let tr = document.createElement("tr");
          i.forEach((j, idx2) => {
            let td = document.createElement("td");
            td.className = `board_color_${(idx + idx2) % 2}`;
            if (j == -1) td.innerHTML = `<div />`;
            if (j == 0) td.innerHTML = `<div class="black"></div>`;
            if (j == 1) td.innerHTML = `<div class="white"></div>`;
            tr.appendChild(td);
          });
          game_table.appendChild(tr);
        });
      }

      /**
       * Util
       */
      function newMain() {
        let main = document.querySelector("#main");
        main.innerHTML = "";
        return main;
      }

      /**
       * CSS Area
       */
      var styles = `
            .room {
                cursor: pointer;
                border: 1px solid black;
            }
            .board_color_0 {
              background: #cba470;
            }
            .board_color_1 {
              background: #c1914f;
            }
            table {
              background: #835f2e;
              border-spacing: 2px;
              border: 20px solid #51150b;
            }
            td {
              width: 54px;
              height: 54px;
              border: 1px solid #e4c8a9;
            }

            .black, .white{
              width: 10px;
              height: 10px;
              border-radius: 50%;
              margin: 5px;
              padding: 17px;
              box-shadow: 0px 4px 10px #482915;
            }

            .white {
              background: white;
            }
            .black {
              background: black;
            }

        `;

      var styleSheet = document.createElement("style");
      styleSheet.type = "text/css";
      styleSheet.innerText = styles;
      document.head.appendChild(styleSheet);
    </script>
  </body>
</html>
